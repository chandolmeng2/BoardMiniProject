package com.example.board.like.service;

import com.example.board.like.Like;
import com.example.board.like.repository.LikeRepository;
import com.example.board.post.domain.Post;
import com.example.board.post.repository.PostRepository;
import com.example.board.user.domain.User;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class LikeService {

	private final LikeRepository likeRepository;
	private final PostRepository postRepository;

	public void toggleLike(Long postId, User user, boolean liked) {
		Post post = postRepository.findById(postId).orElseThrow(() -> new IllegalArgumentException("해당 게시글이 없습니다."));
		Optional<Like> existingOpt = likeRepository.findByPostIdAndUserId(postId, user.getId());

		if (existingOpt.isPresent()) {
			Like existing = existingOpt.get();
			if (existing.isLiked() == liked) {
				likeRepository.delete(existing); // 같은 상태면 취소
			} else {
				existing.setLiked(liked);
				likeRepository.save(existing);
			}
		} else {
			Like like = Like.builder().post(post).user(user).liked(liked).build();
			likeRepository.save(like);
		}
	}

	public int getLikeCountByPostId(Long postId) {
		return likeRepository.countByPostIdAndLikedTrue(postId);
	}

	public int getDislikeCountByPostId(Long postId) {
		return likeRepository.countByPostIdAndLikedFalse(postId);
	}
	
	public void cancelLike(Long postId, User user) {
	    // postId와 user로 해당 Like 엔티티를 찾아서 삭제하거나 상태를 변경
	    Like like = likeRepository.findByPostIdAndUser(postId, user)
	        .orElseThrow(() -> new RuntimeException("Like not found"));
	    likeRepository.delete(like); // 삭제 방식, 또는 like.setLiked(false); 후 저장
	}

}
