package com.example.board.like.controller;

import com.example.board.user.domain.User;
import com.example.board.user.service.UserService;
import com.example.board.like.service.LikeService;
import lombok.RequiredArgsConstructor;

import java.util.HashMap;
import java.util.Map;

import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/posts")
@RequiredArgsConstructor
public class LikeController {

	private final LikeService likeService;
	private final UserService userService;

	@GetMapping("/{postId}/likes")
	public Map<String, Integer> getLikeDislikeCount(@PathVariable("postId") Long postId) {
		int likeCount = likeService.getLikeCountByPostId(postId);
		int dislikeCount = likeService.getDislikeCountByPostId(postId);

		Map<String, Integer> response = new HashMap<>();
		response.put("likeCount", likeCount);
		response.put("dislikeCount", dislikeCount);

		return response;
	}

	@PostMapping("/{postId}/like")
	public void like(@PathVariable("postId") Long postId, @AuthenticationPrincipal UserDetails userDetails) {
		User user = userService.findByUsername(userDetails.getUsername());
		likeService.toggleLike(postId, user, true);
	}

	@PostMapping("/{postId}/dislike")
	public void dislike(@PathVariable("postId") Long postId, @AuthenticationPrincipal UserDetails userDetails) {
		User user = userService.findByUsername(userDetails.getUsername());
		likeService.toggleLike(postId, user, false);
	}
	
	@PostMapping("/{postId}/like/cancel")
	public void cancelLike(@PathVariable("postId") Long postId, @AuthenticationPrincipal UserDetails userDetails) {
	    User user = userService.findByUsername(userDetails.getUsername());
	    likeService.cancelLike(postId, user);
	}

	@PostMapping("/{postId}/dislike/cancel")
	public void cancelDislike(@PathVariable("postId") Long postId, @AuthenticationPrincipal UserDetails userDetails) {
	    User user = userService.findByUsername(userDetails.getUsername());
	    likeService.cancelDislike(postId, user);
	}


}
